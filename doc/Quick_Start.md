
# AddonPayments SDK Documentation

## Introduction and QuickStart

### Table of Contents
- [Introduction](#introduction)
- [Environment](#environment)
- [Composer Install Guide Using the Artifact Repositories](#composer-install-guide-using-the-artifact-repositories)
- [Autoloading the SDK](#autoloading-the-sdk)
- [Setting Up the Payment Notification Webhook](#setting-up-the-payment-notification-webhook)
- [Error Handling in the PHP SDK](#error-handling-in-the-php-sdk)

## Introduction

The AddonPayments SDK is designed to allow quick and easy, yet flexible integration of payment processing capabilities within your ecommerce project. This guide provides all necessary information for starting the integration, and specific sections provide all the details to get any payment processing type integrated. You are advised to complement this information with the documentation provided in the official [AddonPayments documentation site](https://docs.globalpayments.es).

## Environment

**Requirement**:
- Version >= PHP 8.0

## Installing the SDK via Composer

To use the SDK via Composer, follow one of these steps:

1. **Directly Add and Install the Package**:

Run the following command in your terminal to add and install the package directly:

```sh
composer require comerciaglobalpayments/phpsdk
```

2. **Manual Addition to `composer.json`**:

Alternatively, you can manually add the package to your `composer.json` file:

```json
{
    "require": {
        "comerciaglobalpayments/phpsdk": "^1.0"
    }
}
```

Then, run the following command to install the package:

```sh
composer install
```

This will download and install the SDK, ensuring you have the latest version.


## Autoloading the SDK

### Integrating the SDK with Autoloading

This process significantly simplifies the use of SDK features by automatically managing class file inclusions.

### SDK Installation and Autoloading

In a typical PHP project structure, the SDK resides within the `vendor` directory, following the standard Composer setup. For our SDK, the structure would be:

```
/your-project
|
|-- /vendor
|   |-- /phpsdk
|   |   |-- /addonpayments
|   |       |-- ... (SDK files and directories)
|   |-- autoload.php
|   |--- ... (other Composer-managed files and directories)
|
|-- ... (other project files and directories)
```

Here, `autoload.php` is the script generated by Composer, responsible for autoloading classes.

### Using SDK Examples

Within the AddonPayments SDK, there's an `examples` folder that provides sample implementations. To utilize these examples:

1. **Locate the Examples**: The examples folder is situated within the SDK, specifically at `/vendor/phpsdk/addonpayments/examples`.
2. **Copy Examples to Project**: If integrators require practical usage examples, they can copy this folder to their main project directory. This allows for easy access and modification without altering the original SDK files.
3. **Include Examples in the Project**:
    - The examples can be placed directly in the root of the project or within a specific directory, depending on the project's organization.
    - The directory structure after copying the examples might look like this:
    ```
    /your-project
    |
    |--- /examples
    |   |-- ... (copied SDK examples)
    |
    |--- /vendor
    |   |-- ... (Composer and SDK directories)
    |
    |-- ... (other project files and directories)
    ``` 

### Setting Up Autoloading

To utilize the SDK features in any PHP file of the project, the first step is to include the Composer-generated autoloader:

```php
require_once __DIR__ . '/vendor/autoload.php';
```

This line ensures that the autoloader is activated, and it handles the inclusion of the necessary SDK class files as they are needed.

### Using the Credentials File with SDK Examples

The addition of a `credentials.php` file in the examples folder streamlines the process of managing credentials across different examples. This section provides instructions on how to utilize the credentials file with the SDK examples.

#### Understanding the Credentials File

The `credentials.php` file is a centralized location for storing your merchant credentials. It contains the necessary details like Merchant ID, Merchant Password, Merchant Key, and Product ID. This setup ensures that you only need to set your credentials once, and they can be used across all examples.

#### Steps to Use the Credentials File

- **Locate the Credentials File**: Find the `credentials.php` file within the examples directory at `/yourproject/examples/credentials.php`.
- **Set Your Credentials**: Before using the examples, ensure that your credentials are correctly set in the `credentials.php` file. This file should define and export the necessary credential variables.

## Namespace Imports

```php
use AddonPaymentsSDK\AddonPaymentsSDK;
use AddonPaymentsSDK\Config\Configuration;
use AddonPaymentsSDK\Config\Parameters\Parameters;
use AddonPaymentsSDK\Config\Credentials;
use AddonPaymentsSDK\Config\Enums\CountryCodes;
use AddonPaymentsSDK\Config\Enums\CurrencyCodes;
use AddonPaymentsSDK\Config\Enums\PaymentSolutions;
use AddonPaymentsSDK\Config\Enums\Environment;
use AddonPaymentsSDK\Config\Enums\OperationTypes;
use AddonPaymentsSDK\Config\Enums\Types;
use AddonPaymentsSDK\Config\Enums\RecurringTypes;
use AddonPaymentsSDK\Requests\Utils\Exceptions\ClientErrorException;
use AddonPaymentsSDK\Requests\Utils\Exceptions\NetworkException;
use AddonPaymentsSDK\Requests\Utils\Exceptions\ServerErrorException;
use AddonPaymentsSDK\Requests\Utils\Exceptions\InvalidFieldException;
use AddonPaymentsSDK\Requests\Utils\Exceptions\MissingFieldException;
```

## Currently Supported Operations

- **Credit Cards**
    - Hosted Redirection
    - Host to Host 
    - JavaScript Auth token
    - JavaScript Charge Request
- **Quix**
    - Quix Hosted Request
    - Quix Charge Request

## Usage

In this section, we explain the generic process of processing transactions. Some details can vary depending on the type of transaction (please refer to the specific transaction type documentation for more information).

As high-level steps, in order to process transactions with the SDK, the following steps have to be followed:

1. Set Credentials
2. Configure the transaction parameters
3. Send a Request and parse the response
4. Receive Transaction Status Notifications in your WebHook, and update the transaction status in your backend

### Set Credentials

In order to use the SDK, you will need the following information:
- **setMerchantId**: Identifier of your business on the Addon Payments platform.
- **setMerchantPassword**: The Secret Passphrase used inside AES-256 encryption provided by AddonPayments.
- **setProductId**: Product identifier created for your business by AddonPayments for which the transaction must be processed.
- **setEnvironment**: Switch between staging or production environment.

Please consult with your sales representative on how to obtain this information.

To set Credentials, use the class `Credentials`, as follows:

```php
$cred = new Credentials();
$cred->setMerchantId(MERCHANT_ID)
     ->setMerchantPassword(MERCHANT_PASS)
     ->setProductId(PRODUCT_ID)
     ->setEnvironment(Environment::STAGING);
```

### Setting Payment Parameters

To set the payment parameters, use the class `Parameters`:

```php
$parameters = new Parameters();
$parameters->setAmount(30)
       ->setCurrency(CurrencyCodes::EUR)
       ->setCountry(CountryCodes::ES)
       ->setCustomerId('1')
       ->setOperationType(OperationTypes::DEBIT)      
       ->setPaymentSolution(PaymentSolutions::CREDITCARDS)
       ->setMerchantTransactionId('87145')
       ->setStatusURL('https://test.com/status')
       ->setSuccessURL('https://test.com/success')
       ->setErrorURL('https://test.com/error')
       ->setCancelURL('https://test.com/cancel')
       ->setAwaitingURL('https://test.com/awaiting')
       ->setMerchantParams(['key' => 'value']);
```

### Create The Payment Configuration

To create the payment configurations, use the class `Configuration` and provide it with the payment credentials and parameters:

```php
$config = new Configuration($cred, $parameters);
```

### Send Payment Hosted Redirection Request

#### Step 1: Initialize the SDK

To send the payment redirection request, create an `AddonPaymentsSDK` object and provide it with the configuration created:

```php
$sdk = new AddonPaymentsSDK($config);
```

#### Step 2: Create Hosted Payment Request

After setting the credentials and the parameters for the request, use `sendRedirectionPaymentRequest` to create the hosted request:

```php
$request = $sdk->sendRedirectionPaymentRequest();
```

#### Step 3: Retrieve Redirection URL

After executing the payment request, retrieve the redirection URL by using the `getRedirectUrl` method from the response object provided by `$hosted`.

```php
$request->getResponse()->getRedirectUrl();
```

**Note:** After retrieving the redirection URL, it is essential to redirect the user to this URL to complete the payment process. Additionally, it's important to note that the status of the transaction, whether it's a success or an error, will be communicated asynchronously via a webhook notification. Within the SDK, we've included a method to create a webhook and notification handler, enabling you to receive these transaction notifications efficiently and take action. This allows for real-time updates on transaction statuses directly within your application.

### Full Code Example Hosted

```php
<?php
include __DIR__ . '/../../../vendor/autoload.php';

use AddonPaymentsSDK\AddonPaymentsSDK;
use AddonPaymentsSDK\Config\Configuration;
use AddonPaymentsSDK\Config\Parameters\Parameters;
use AddonPayments

SDK\Config\Credentials;
use AddonPaymentsSDK\Config\Enums\CountryCodes;
use AddonPaymentsSDK\Config\Enums\CurrencyCodes;
use AddonPaymentsSDK\Config\Enums\PaymentSolutions;
use AddonPaymentsSDK\Config\Enums\Environment;
use AddonPaymentsSDK\Requests\Utils\Exceptions\ClientErrorException;
use AddonPaymentsSDK\Requests\Utils\Exceptions\NetworkException;
use AddonPaymentsSDK\Requests\Utils\Exceptions\ServerErrorException;
use AddonPaymentsSDK\Requests\Utils\Exceptions\InvalidFieldException;
use AddonPaymentsSDK\Requests\Utils\Exceptions\MissingFieldException;

try {
       // Configuration of merchant credentials.
       $cred = new Credentials();
       $cred->setMerchantId(getenv('MERCHANT_ID'))
              ->setMerchantPassword(getenv('MERCHANT_PASS'))
              ->setMerchantKey(getenv('MERCHANT_KEY'))
              ->setProductId(getenv('PRODUCT_ID'));
       
       // Setting up payment request parameters, including customer and transaction details.        
       $parameters = new Parameters();
       $parameters->setAmount(30)
       ->setCurrency(CurrencyCodes::EUR)
       ->setCountry(CountryCodes::ES)
       ->setCustomerId('1')
       ->setOperationType(OperationTypes::DEBIT)      
       ->setPaymentSolution(PaymentSolutions::CREDITCARDS)
       ->setMerchantTransactionId('87145')
       ->setStatusURL('https://test.com/status')
       ->setSuccessURL('https://test.com/success')
       ->setErrorURL('https://test.com/error')
       ->setCancelURL('https://test.com/cancel')
       ->setAwaitingURL('https://test.com/awaiting')
       ->setMerchantParams(['key' => 'value']);
              
       $env = Environment::STAGING;
       $config = new Configuration($cred, $parameters, $env);
       $sdk = new AddonPaymentsSDK($config);
} catch (TypeError $e) {
       echo 'TypeError: ' . $e->getMessage(), PHP_EOL;
} catch (InvalidFieldException $e) {
       echo 'InvalidFieldException: ' . $e->getMessage(), PHP_EOL;
} catch (MissingFieldException $e) {
       echo 'MissingFieldException: ' . $e->getMessage(), PHP_EOL;
} catch (Exception $e) {
       echo 'Exception: ' . $e->getMessage(), PHP_EOL;
}

try {
       // Sending the payment request to AddonPayments and receiving a redirection URL for the payment gateway.
       $request = $sdk->sendRedirectionPaymentRequest();
       echo 'SendRequest: ' . $hosted->getResponse()->getRedirectUrl();
} catch (InvalidFieldException $e) {
       echo 'InvalidFieldException: ' . $e->getMessage(), PHP_EOL;
} catch (MissingFieldException $e) {
       echo 'MissingFieldException: ' . $e->getMessage(), PHP_EOL;
} catch (NetworkException $e) {
       echo 'NetworkException: ' . $e->getMessage(), PHP_EOL;
} catch (ServerErrorException $e) {
       echo 'ServerErrorException: ' . $e->getMessage(), PHP_EOL;
} catch (ClientErrorException $e) {
       echo 'ClientErrorException: ' . $e->getMessage(), PHP_EOL;
} catch (Exception $e) {
       echo 'Exception: ' . $e->getMessage(), PHP_EOL;
}
?>
```

## Setting Up the Payment Notification Webhook

AddonPayments will send notifications to the URL that you configure, as the transaction progresses through different stages. You should set up a webhook endpoint using the `NotificationHandler` class. This notification is received in JSON or XML format (depending on how you configure it in the back-office administration panel). The SDK provides two classes for dealing with Notifications:

- **NotificationHandler** - receives the notification in your Webhook
- **Transaction** - parses the XML or JSON notification and offers a set of convenient getters that will assist in processing the status of the transaction (for example, deciding if a transaction is approved or declined).

### Import Necessary Classes

At the start of your webhook, include the necessary classes.

```php
include __DIR__ . '/vendor/autoload.php';

use AddonPaymentsSDK\NotificationHandler;
use AddonPaymentsSDK\NotificationModel\Transaction;
```

### Initialize the NotificationHandler

```php
$handler = new NotificationHandler();
```

### Define the Notification Callback

```php
$handler->setNotificationCallback(function($xml) {
    // Process the notification.
    // You might want to update your database, send a confirmation email, etc.
    $transaction = new Transaction($xml);
    $status = $transaction->getOperations()->getPaymentSolutionOperation()->getStatus();
    if($status == 'SUCCESS'){
       echo "Transaction Completed Successfully";
    } else {
       echo "Transaction Not Completed";
    }
});
```

### Handle the Notification

To ensure your webhook properly receives and processes the notifications, add the `handleNotification` method at the end of your webhook script. This method listens for incoming notifications and triggers the defined callback.

```php
$handler->handleNotification();
```

### Full Code Example Inside Your Webhook

```php
<?php

include __DIR__ . '/../../vendor/autoload.php';
use AddonPaymentsSDK\NotificationHandler;
use AddonPaymentsSDK\NotificationModel\Transaction;

// Usage
$handler = new NotificationHandler();
$handler->setNotificationCallback(function($xml) {
    $transaction = new Transaction($xml);
    $status = $transaction->getOperations()->getPaymentSolutionOperation()->getStatus();
    if($status == 'SUCCESS'){
       echo "Transaction Completed Successfully";
    } else {
       echo "Transaction Not Completed";
    }
});
$handler->handleNotification();
?>
```

## Handle Notification Data

The `Transaction` class is responsible for parsing this XML or JSON data to extract the required details about a transaction.

### Import Necessary Classes

To begin, you need to include the necessary classes.

```php
include __DIR__ . '/vendor/autoload.php';

use AddonPaymentsSDK\Transaction;
```

### Initialize the Transaction Class with XML or JSON Data

```php
$xmlData = /* Your XML or JSON data here */;
$transaction = new Transaction($xmlData);
```

### Retrieve Transaction Details

Once the `Transaction` class has been initialized with the XML data, you can use its methods to retrieve the transaction details.

```php
// Get transaction ID
$transaction_id = $transaction->getOperations()->getPaymentSolutionOperation()->getTransactionId();

// Get merchant transaction ID
$merchant_transaction_id = $transaction->getOperations()->getPaymentSolutionOperation()->getMerchantTransactionId();

// Get payment status
$status = $transaction->getOperations()->getPaymentSolutionOperation()->getStatus();

// Get payment amount
$paymentAmount = $transaction->getOperations()->getPaymentSolutionOperation()->getAmount();

// ... and so on for other details you might need
```

### Processing Notifications

Processing the notifications is heavily dependent on the workflow that is configured for your merchant. The `Transaction` class will offer all necessary getters to properly deal with the notifications you will receive according to the transaction workflow.

However, as a basic rule that can be considered is how to determine if a transaction is approved or declined, the following code can be used:

### Full Code Example for Parsing XML

```php
<?php

include __DIR__ . '/../vendor/autoload.php';

use AddonPaymentsSDK\Transaction;

// Assume XML or JSON data is obtained from a source, like a webhook POST request, Database
$xmlData = /* Your XML or JSON data here */;

$transaction = new Transaction($xmlData);

// Retrieve transaction details
$status = $transaction->getOperations()->getPaymentSolutionOperation()->getStatus();

// Implement your business logic based on these details
// This could include updating databases, sending confirmation emails, etc.

if($status == 'SUCCESS'){
       echo "Transaction Completed Successfully";
} else {
       echo "Transaction Not Completed";
}
?>
```

## Error Handling in the PHP SDK

In the process of integrating and utilizing the PHP SDK for payment gateway interactions, various types of errors can occur. These errors might originate from different layers of the application, including the SDK itself, the Payment Gateway (PGW), or the underlying network. Understanding and handling these errors appropriately is crucial for a robust and user-friendly application. Here's an overview of common error types and how to handle them in the PHP SDK context.

### Types of Errors

1. **SDK Errors**:
    - **TypeError**: Occurs when a function is called with an argument of an inappropriate type.
    - **FieldException**: A parent exception for field-related errors.
        - **MissingFieldException**: Raised when mandatory data is missing, ensuring all necessary information is provided before proceeding with any operations, particularly those critical to the payment process.
        - **InvalidFieldException**: Raised when provided data is outside the expected values or is inappropriate for the given context.

2. **Network Errors**:
    - **NetworkException**: These exceptions are thrown when there is a failure in network communication, such as timeouts or connectivity issues.

3. **Payment Gateway (PGW) Errors**:
    - **ClientErrorException**: This exception is related to client-side errors (4xx HTTP status codes), indicating issues like invalid request parameters.
    - **ServerErrorException**: Represents server-side errors (5xx HTTP status codes) within the payment gateway, indicating issues on the PGW end.

### Error Handling Mechanism

To effectively manage errors in the PHP SDK, a `try-catch` block is used. This approach ensures that the application can gracefully handle exceptions and provide informative feedback to the user or the calling process. Here's an example of how to implement error handling:

```php
try {
    //

 Your code for SDK configuration and request preparation goes here.
   
} catch (InvalidFieldException $e) {
       echo 'InvalidFieldException: ' . $e->getMessage(), PHP_EOL;
} catch (MissingFieldException $e) {
       echo 'MissingFieldException: ' . $e->getMessage(), PHP_EOL;
} catch (NetworkException $e) {
       echo 'NetworkException: ' .  $e->getMessage(), PHP_EOL;
} catch (ServerErrorException $e) {
       echo 'ServerErrorException: ' . $e->getMessage(), PHP_EOL;
} catch (ClientErrorsException $e) {
        echo 'ClientErrorsException: ' . $e->getMessage(), PHP_EOL;
} catch (Exception $e) {
       echo 'Exception: ' . $e->getMessage(), PHP_EOL;
}
```